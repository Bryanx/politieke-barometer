@using System
@using System.Web.Optimization
<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <!-- Meta, title, CSS, favicons, etc. -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>@ViewData["Title"]</title>

    @Styles.Render("~/Content/css")

    @if (IsSectionDefined("CustomCSS")) {
        @RenderSection("CustomCSS")
    }

    <!-- Custom Theme Style -->
    @Styles.Render("~/Content/custom")
    
    <!-- Font -->
    <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
</head>

<body class="nav-sm">
<div class="container body">
<div class="main_container">
<div class="col-md-3 left_col nav-fixed">
    <div class="left_col scroll-view">
        <div class="navbar nav_title" style="border: 0;">
            <a href="/" class="site_title">
                <i class="small-logo"></i>
            </a>
        </div>

        <div class="clearfix"></div>

        <!-- menu profile quick info -->
        <div class="profile clearfix">
            <div class="profile_pic">
                <img src="../../Content/build/images/img.jpg" alt="..." class="img-circle profile_img">
            </div>
            <div class="profile_info">
                <span>Welcome,</span>
                <h2>John Doe</h2>
            </div>
        </div>
        <!-- /menu profile quick info -->

        <br/>

        <!-- sidebar menu -->
        <div id="sidebar-menu" class="main_menu_side hidden-print main_menu">
            <div class="menu_section">
                <ul class="nav side-menu">
                    @Html.Partial("~/Views/Shared/NavBarLinks.cshtml")
                </ul>
            </div>

        </div>
        <!-- /sidebar menu -->

        <!-- /menu footer buttons -->
        <div class="sidebar-footer hidden-small">
            <a data-toggle="tooltip" data-placement="top" title="Settings">
                <span class="glyphicon glyphicon-cog" aria-hidden="true"></span>
            </a>
            <a data-toggle="tooltip" data-placement="top" title="FullScreen">
                <span class="glyphicon glyphicon-fullscreen" aria-hidden="true"></span>
            </a>
            <a data-toggle="tooltip" data-placement="top" title="Lock">
                <span class="glyphicon glyphicon-eye-close" aria-hidden="true"></span>
            </a>
            <a data-toggle="tooltip" data-placement="top" title="Logout" href="login.html">
                <span class="glyphicon glyphicon-off" aria-hidden="true"></span>
            </a>
        </div>
        <!-- /menu footer buttons -->
    </div>
</div>

<!-- top navigation -->
<div class="top_nav">
    <div class="nav_menu">
        <nav>
            <div class="nav toggle">
                <a id="menu_toggle">
                    <i class="fa fa-bars"></i>
                </a>
            </div>

            <!-- login -->
            <ul class="nav navbar-nav navbar-right">
                <li class="">
                    <a href="javascript:;" class="user-profile dropdown-toggle" data-toggle="dropdown"
                       aria-expanded="false">
                        <img src="../../Content/build/images/img.jpg" alt="">John Doe
                        <span class=" fa fa-angle-down"></span>
                    </a>
                    <ul class="dropdown-menu dropdown-usermenu pull-right">
                        <li>
                            <a href="javascript:;"> Profile</a>
                        </li>
                        <li>
                            <a href="javascript:;">
                                <span class="badge bg-red pull-right">50%</span>
                                <span>Settings</span>
                            </a>
                        </li>
                        <li>
                            <a href="javascript:;">Help</a>
                        </li>
                        <li>
                            <a href="login.html"><i class="fa fa-sign-out pull-right"></i> Log Out</a>
                        </li>
                    </ul>
                </li>
                <!-- alerts -->
                <li role="presentation" class="dropdown">
                    <a id="alertDropdown" href="javascript:;" class="dropdown-toggle info-number" data-toggle="dropdown"
                       aria-expanded="false">
                        <i class="fa fa-envelope-o"></i>
                        <span id="alertCount" class="badge bg-green"></span>
                    </a>
                    <div class="dropdown-menu msg_list" role="menu">
                        <ul class="list-unstyled msg_list msg_headers">
                            <li class="alertMenuHeader"><strong>Alerts</strong></li>
                            <li class="alertWindowsSettings"><a>Intellingen</a></li>
                        </ul>
                        <ul id="menu1" class=" list-unstyled msg_list">
                            <div class="loadingAlerts"></div>
                        </ul>
                    </div>
                </li>
            </ul>
            <!-- search -->
            @Html.Partial("~/Views/Shared/SearchBar.cshtml")
        </nav>
    </div>
</div>
<!-- /top navigation -->

<!-- page content -->
<div class="right_col" role="main">
    @RenderBody()
</div>
<!-- /page content -->

<!-- footer content -->
<footer>
    <div class="pull-right">
        &copy; @DateTime.Now.Year - Barometer
    </div>
    <div class="clearfix"></div>
</footer>
<!-- /footer content -->
</div>
</div>

<!-- Scripts -->
@Scripts.Render("~/bundles/jquery","~/bundles/bootstrap","~/bundles/flot","~/bundles/dates","~/bundles/pnotify","~/bundles/timeago")

@if (IsSectionDefined("CustomJS")) {
    @RenderSection("CustomJS")
}

<script type="text/javascript">

    var alertcount;
    
    //Updates the alert count icon
    function updateAlertCount() {
        if (this.alertcount <= 0) {
            $('#alertCount').hide();
        } else {
            $('#alertCount').show();
            $('#alertCount').html(this.alertcount);
        }
    }
    
    //When an alert is clicked, this function is called.
    //It sets the property isRead of the Alert to true.
    function markAsRead(id) {
        var alert = $('#alert' + id);
        if (!alert.hasClass('alertRead')) {
            alert.addClass('alertRead');
            this.alertcount = alertcount - 1;
            updateAlertCount();
        }
        $.ajax('/api/User/'+@ViewBag.Id+'/Alert/'+id+'/Read',
                {
                    type: 'PUT',
                    dataType: 'json'
                })
            .done(function(data) {
                //ok
            })
            //TODO: if FAIL proper error handling
            .fail(function() { alert('Cannot change alert.'); });
    }
        

    //Inserts the HTML for the alerts inside the alert dropdownlist in the top-navbar
    function InsertAlerts(alertData) {
        $('#menu1').empty();
        var counter = 0;
        for (var i = 0; i < alertData.length; i++) {
            var alert = alertData[i];
            var read = "";
            if (alert.IsRead) {
                read = "alertRead";
            }
            //Add alert to alert dropdownlist
            $('#menu1').append("<li class=\"alertMessage"+alert.AlertId+" "+read+"\" onclick=\"markAsRead("+alert.AlertId+"); " +
                "location.href = \'/Person/Details/"+alert.AlertId+"\';\"><a>" +
                "<div class=\"alertIcon\"><i class=\"fa fa-user\"></i></div>" +
                "<span><span><strong>"+alert.Name+"</strong> is nu trending!</span></span>" +
                "<span class=\"alertTime\"><i class=\"font_11 fa fa-clock-o\"></i> "+jQuery.timeago(alert.TimeStamp)+"</span></a></li>");

            if (!alert.IsRead) {
                counter++;
            }
        }
        //Update the alertCounter
        this.alertcount = counter;
        updateAlertCount();
    }
    
    //Ajax GET request: loads all alerts and calls InsertAlerts() method to add HTML to the page.
    function loadAlerts() {
        $(".loadingAlerts").css("display","block");
        $.ajax('/api/User/@ViewBag.Id/GetAlerts',
                {
                    type: 'GET',
                    dataType: 'json'
                })
            .done(function(data) {
                $(".loadingAlerts").css("display", "none");
                //There are alerts available
                if (data != undefined) {
                    var alertData = data;
                    console.log(alertData);
                    InsertAlerts(data);
                    $('#menu1').append(
                        "<li id=\"seeAllAlerts\"><div class=\"text-center\"><a><strong>Bekijk alle alerts</strong></a></div></li>");
                } else { //No available alerts
                    $('#menu1').empty();
                    $('#menu1').append("<li class=\"noAlertsAvailable\"><i class=\"fa fa-envelope-o\"></i></br><strong>Je hebt nog geen alerts.</strong></br>Abboneer jezelf op personen, partijen of thema's</br>om te zien wanneer ze trending zijn.</li>");
                }
            })
            //TODO: if FAIL proper error handling
            .fail(function() {
                //error handling.
                //currently not implemented because database needs to be initialized on page reload.
            });
    }
    (function() {
        loadAlerts();
        //Everytime the alert button is clicked, they are reloaded.
        $('#alertDropdown').on('click', loadAlerts);
    })(jQuery);
</script>

<!-- Custom Theme Scripts -->
@Scripts.Render("~/bundles/custom")

</body>
</html>